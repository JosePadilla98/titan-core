---
interface MediaItem {
    src: string;
    alt?: string;
    type: 'image' | 'video';
}

interface Props {
    media: MediaItem[];
    class?: string;
}

const { media, class: className } = Astro.props;
---

<div class={`carousel-container ${className || ''}`}>
    <!-- Main Carousel -->
    <div class="carousel-main">
        <div class="carousel-main__viewport">
            <div class="carousel-main__container">
                {
                    media.map((item, index) => (
                        <div class="carousel-main__slide">
                            {item.type === 'image' ? (
                                <img
                                    src={item.src}
                                    alt={item.alt || `Slide ${index + 1}`}
                                    class="carousel-main__image"
                                    loading={index === 0 ? 'eager' : 'lazy'}
                                />
                            ) : (
                                <video
                                    src={item.src}
                                    class="carousel-main__video"
                                    controls
                                    preload={index === 0 ? 'metadata' : 'none'}
                                />
                            )}
                        </div>
                    ))
                }
            </div>
        </div>
    </div>

    <!-- Thumbnails Carousel -->
    <div class="carousel-thumbnails">
        <div class="carousel-thumbnails__viewport">
            <div class="carousel-thumbnails__container">
                {
                    media.map((item, index) => (
                        <div class="carousel-thumbnails__slide">
                            <button class="carousel-thumbnails__button" type="button" data-slide={index}>
                                {item.type === 'image' ? (
                                    <img
                                        src={item.src}
                                        alt={item.alt || `Thumbnail ${index + 1}`}
                                        class="carousel-thumbnails__image"
                                    />
                                ) : (
                                    <div class="carousel-thumbnails__video-placeholder">
                                        <svg
                                            class="carousel-thumbnails__play-icon"
                                            viewBox="0 0 24 24"
                                            fill="currentColor"
                                        >
                                            <path d="M8 5v14l11-7z" />
                                        </svg>
                                    </div>
                                )}
                            </button>
                        </div>
                    ))
                }
            </div>
        </div>
    </div>
</div>

<script>
    import EmblaCarousel from 'embla-carousel';
    import Autoplay from 'embla-carousel-autoplay';

    function setupCarousel(container: HTMLElement) {
        const mainViewport = container.querySelector('.carousel-main__viewport') as HTMLElement;
        const thumbnailsViewport = container.querySelector('.carousel-thumbnails__viewport') as HTMLElement;

        if (!mainViewport || !thumbnailsViewport) return;

        const autoplay = Autoplay({ delay: 4000 });

        const mainCarousel = EmblaCarousel(
            mainViewport,
            {
                loop: true,
                align: 'center',
            },
            [autoplay],
        );

        const thumbnailsCarousel = EmblaCarousel(thumbnailsViewport, {
            containScroll: 'keepSnaps',
            dragFree: true,
            align: 'start',
        });

        // Pause autoplay on pointer down and resume on pointer up
        mainCarousel.on('pointerDown', () => autoplay.stop());
        mainCarousel.on('pointerUp', () => autoplay.play());

        // Sync thumbnails with main carousel
        mainCarousel.on('select', () => {
            const selectedIndex = mainCarousel.selectedScrollSnap();
            thumbnailsCarousel.scrollTo(selectedIndex);

            // Update active thumbnail
            const thumbnailButtons = thumbnailsViewport.querySelectorAll('.carousel-thumbnails__button');
            thumbnailButtons.forEach((button: Element, index: number) => {
                (button as HTMLElement).classList.toggle('is-selected', index === selectedIndex);
            });
        });

        // Handle thumbnail clicks
        const thumbnailButtons = thumbnailsViewport.querySelectorAll('.carousel-thumbnails__button');
        thumbnailButtons.forEach((button: Element, index: number) => {
            button.addEventListener('click', () => {
                autoplay.stop();
                mainCarousel.scrollTo(index);
                // Resume autoplay after interaction
                setTimeout(() => autoplay.play(), 4000);
            });
        });

        // Set initial active thumbnail
        const firstButton = thumbnailButtons[0];
        if (firstButton) {
            firstButton.classList.add('is-selected');
        }

        return () => {
            mainCarousel.destroy();
            thumbnailsCarousel.destroy();
        };
    }

    // Initialize when DOM is ready
    function initializeCarousels() {
        document
            .querySelectorAll('.carousel-container')
            .forEach((container) => setupCarousel(container as HTMLElement));
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCarousels);
    } else {
        initializeCarousels();
    }
</script>

<style>
    .carousel-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .carousel-main {
        overflow: hidden;
    }

    .carousel-main__viewport {
        overflow: hidden;
    }

    .carousel-main {
        --slide-spacing: 1rem;
        --slide-size: 100%;
    }

    .carousel-main__container {
        display: flex;
        margin-left: calc(var(--slide-spacing) * -1);
    }

    .carousel-main__slide {
        flex: 0 0 var(--slide-size);
        min-width: 0;
        padding-left: var(--slide-spacing);
        display: flex;
        align-items: center;
        justify-content: center;
        max-height: 650px;
    }

    .carousel-main__image,
    .carousel-main__video {
        width: 100%;
        height: auto;
        object-fit: contain;
        border-radius: 0.5rem;
    }

    .carousel-thumbnails {
        --thumbs-slide-spacing: 0.8rem;
        overflow: hidden;
    }

    .carousel-thumbnails__viewport {
        overflow: hidden;
    }

    .carousel-thumbnails__container {
        display: flex;
        margin-left: calc(var(--thumbs-slide-spacing) * -1);
    }

    .carousel-thumbnails__slide {
        flex: 0 0 22%;
        min-width: 0;
        padding-left: var(--thumbs-slide-spacing);
    }

    @media (min-width: 576px) {
        .carousel-thumbnails__slide {
            flex: 0 0 15%;
        }
    }

    .carousel-thumbnails__button {
        width: 100%;
        height: 80px;
        border: 2px solid transparent;
        border-radius: 0.375rem;
        overflow: hidden;
        cursor: pointer;
        transition: border-color 0.2s ease;
        background: none;
        padding: 0;
    }

    .carousel-thumbnails__button:hover {
        border-color: #3b82f6;
    }

    .carousel-thumbnails__button.is-selected {
        border-color: #2563eb;
    }

    .carousel-thumbnails__image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .carousel-thumbnails__video-placeholder {
        width: 100%;
        height: 100%;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
    }

    .carousel-thumbnails__play-icon {
        width: 24px;
        height: 24px;
    }
</style>
